## 分几步实现一个简单的响应式前端框架(一)：template parse

###前言

这几篇博客写于17年8月正在准备找工作的时候，由于之前看过React的源代码，并且这时最流行的响应式前端框架主要有两个，其一是React，由facebook主导的一个开源项目，另外一个是Vue，是yyx大神自己开始架构的一个开源项目。所以希望对Vue的源码也有一定的了解，就准备着手自己实现一个简单的响应式框架。其实也是在阅读Vue源码的时候对于其核心部分逻辑的一个拆解和简化，帮助自己更好的理解Vue在构建和更新过程中的操作。

当然由于还没有工作经验，写出来的代码会有一些简陋，但是希望能够帮助大家在使用Vue的时候，更好的理解其中内部的原理，而不是简单的使用。

### React和Vue的响应式区别

这里的响应式指的是当数据层发生了变化的时候，表现层能够根据数据变化得到相应的改变，来适应数据的变化，而通过阅读了一部分的关键源代码，了解到了这两个最流行的前端框架对于数据改变的响应方式的区别。

由于React项目架构较早，其使用的是自己的一套状态管理，所有组件的状态都通过`state`保存在虚拟DOM中，也就是将组件最为实例对象保存在浏览器内存当中，当我们调用`setState`的时候，其会响应状态的变化，将新的状态合并到旧的状态中，来实现组件实例的更新，再通过`render`函数来渲染出真正的DOM挂载到页面中。而所有的子组件通过获取父组件传递的`props`来响应父组件状态的变化。

而Vue通过组件初始化时设置的一些状态属性，使用存取器`getter/setter`来拦截对于状态的修改，通过收集依赖，将所有的更新发送到各个组件来进行更新，由于Vue对于状态更新的操作要远远少于React(当然React对于自己状态的比较采用了很多优化的方法)，所以Vue整体上来说要比React稍微简单一些。所以本次实现主要根据Vue文档中的各种方法来进行实现。

### Vue

Vue的方法和使用就不多赘述了，在官方文档中都具有比较完整的方法接口和描述。

主要的实现结构：

* 使用模板来创建`render`函数，当然也可以手动进行，因为模板的学习成本还是要小于React的JSX语法的。并且当前React使用了非常多的ES6语法，还是有着一定的学习成本的。
* 使用`getter/setter`来拦截状态修改，更新UI。
* 使用发布/订阅设计模式来进行响应式操作。

本次的实现也是基于上面几点，不知道什么时候能够完成，但是在慢慢研读源码和写代码的过程中也会对自己的代码能力和编程思想有很大的提升。希望自己能够完成这一系列博客。由于现在ES6的支持率已经很高了，而且我自己的环境基本已经支持所有的ES6语言，并且还有babel神器可以进行代码的编译，所以下面所有的代码都会基于原生ES6的语法来进行实现。但不会使用ES6的`class`来进行类的实现，还是自己控制原型比较习惯。

### 模板解析

首先，由于组件渲染的结果都是根据模板来进行的，那么对于模板的解析是非常重要的，如何将一个HTML模板解析为JavaScript可以识别的语法也是这个项目最基本的事情。

可以先来看一下Vue的`render()`函数是什么样子的。

```javascript
Vue.component('heading', {
  render: function(createElement) {
    return createElement(
      'h1',
      {
        'class': {
          foo: true,
          bar: false,
        },
        attrs: {
          id: 'foo',
        },
      },
      [
        createElement(
          ....
        )
      ]
    )
  }
});
```

`render`函数通过参数传入的内置的`createElement`函数来构建新的实例DOM，而`createElement`和React基本是一致的，第一个参数是一个字符串，表示组件的名称、或者是一个组件对象，那么就会直接使用这个组件对象。当然在模板字符串编译出来`render`函数中只应该含有字符串参数。

第二个参数是一个对象，这个对象包含了这个组件所有的属性，这个属性可能是绑定属性，也可能是原生属性。

第三个参数是一个数组，这个数组表示了某个组件内部的子元素列表，这些列表就是递归的`createElement`函数调用，这样每一个自定义组件都可以通过这样的迭代来得到一个完成的实例对象。下面就来将模板解析成这样一个函数。

### 模板解析的实现

一个合法的HTML标签格式应该有下面几种：

1. `<!DOCTYPE xxxxx>`用来指定文档的渲染格式。
2. 自闭的HTML标签`<xx />`，这类标签不含有子元素，比如常用的img标签、meta标签。
3. 闭合的HTML标签`<xx></xx>`，这类标签可以含有子元素，是最常用的一种标签类型。
4. comment的HTML标签`<!-- xxx -->`，这类标签代表HTML的注释。

